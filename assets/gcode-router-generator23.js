// ===============================================================
// ðŸ§  CncAi â€” Router G-code Generator (v2.5.1 Final)
// ØªØ­Ø³ÙŠÙ†Ø§Øª: Precision + SafeZ Ø°ÙƒÙŠ + Header/Footer + Buffer + Timing + Safety
// ===============================================================

function fmt(v, p = 3) {
  return Number(v).toFixed(p);
}

/**
 * ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø§Ù„Ù€ Raster (Ø§Ù„Ù†Ø­Øª Ø§Ù„Ø®Ø´Ø¨ÙŠ)
 */
function generateRouterRasterGcode() {
  if (!grayMat || !contour) throw new Error("Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©");

  try {
    InputValidator.validateRouterSettings();

    const feed = parseInt(document.getElementById('feedRate').value) || 800;
    const safeZ = parseFloat(document.getElementById('safeZ').value) || 5;
    const maxDepth = parseFloat(document.getElementById('maxDepth').value) || 3;
    const stepOver = parseFloat(document.getElementById('stepOver').value) || 2;
    const invertZ = document.getElementById('invertZ').checked;
    const useFixedZ = document.getElementById('fixedZ').checked;
    const fixedZValue = parseFloat(document.getElementById('fixedZValue').value) || -1;

    const workWidth = cmToMm(parseFloat(document.getElementById('workWidth').value) || 30);
    const workHeight = cmToMm(parseFloat(document.getElementById('workHeight').value) || 20);
    const originX = 0, originY = 0;

    const lines = [];
    const precision = 3;
    const scaleX = workWidth / previewCanvas.width;
    const scaleY = workHeight / previewCanvas.height;

    let totalLen = 0, moveCount = 0;
    let lastZ = null;

    function moveSafeZ(targetZ) {
      if (lastZ !== targetZ) {
        lines.push(`G0 Z${fmt(targetZ)}`);
        lastZ = targetZ;
      }
    }

    // ================= Header =================
    lines.push('; ============================================================');
    lines.push('; ðŸ§  Generated by CncAi â€” Router Raster Engraving');
    lines.push('; Version: 2.5.1 | Pattern: Raster');
    lines.push('; Date: ' + new Date().toLocaleString());
    lines.push(`; Feed: ${feed} mm/min | SafeZ: ${safeZ} mm | StepOver: ${stepOver}`);
    lines.push('; ============================================================');
    lines.push('G90 G21 G17');
    lines.push('G28 ; Home');
    moveSafeZ(safeZ);
    lines.push('M3 ; Spindle ON');
    lines.push('; --- Begin Raster Pass ---');

    const buffer = [];

    for (let y = 0; y < previewCanvas.height; y += stepOver) {
      const rowPoints = [];

      for (let x = 0; x < previewCanvas.width; x++) {
        const pt = new cv.Point(x, y);
        const inside = cv.pointPolygonTest(contour, pt, false) >= 0;
        if (inside) {
          const pixel = sampleGrayAt(x, y);
          let zVal = useFixedZ ? fixedZValue : -((255 - pixel) / 255.0) * maxDepth;
          if (invertZ) zVal = -zVal;
          const scaledX = (x * scaleX) + originX;
          const scaledY = (y * scaleY) + originY;
          rowPoints.push({ x: scaledX, y: scaledY, z: zVal });
        }
      }

      if (rowPoints.length > 1) {
        const reverse = (y / stepOver) % 2 !== 0;
        if (reverse) rowPoints.reverse();

        // move to start
        moveSafeZ(safeZ);
        buffer.push(`G0 X${fmt(rowPoints[0].x)} Y${fmt(rowPoints[0].y)}`);
        moveSafeZ(rowPoints[0].z);
        buffer.push(`G1 F${feed}`);

        for (let i = 0; i < rowPoints.length; i++) {
          const p = rowPoints[i];
          buffer.push(`G1 X${fmt(p.x)} Y${fmt(p.y)} Z${fmt(p.z)}`);
          moveCount++;
        }

        totalLen += calculateRowLength(rowPoints);
      }

      // flush buffer to prevent overload
      if (buffer.length > 5000) {
        lines.push(...buffer);
        buffer.length = 0;
      }
    }

    lines.push(...buffer);

    // ================= Footer =================
    lines.push('; --- End Raster Pass ---');
    moveSafeZ(safeZ);
    lines.push('M5 ; Spindle OFF');
    lines.push('G0 X0 Y0 ; Return Home');
    lines.push('M84 ; Disable Motors');
    lines.push('M30 ; Program End');
    lines.push('; âœ… Completed Successfully by CncAi');
    lines.push('; ============================================================');

    const timeMin = totalLen / (feed || 1);
    const estNode = document.getElementById('estTime');
    if (estNode) estNode.innerHTML =
      `â±ï¸ ØªÙ‚Ø¯ÙŠØ± ÙˆÙ‚Øª Ø§Ù„ØªØ´ØºÙŠÙ„: ${timeMin.toFixed(1)} Ø¯Ù‚ÙŠÙ‚Ø© | ${moveCount} Ø­Ø±ÙƒØ©`;

    return lines.join('\n');
  } catch (e) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø§Ù„Ø±Ø§ÙˆØªØ± Raster:', e);
    throw e;
  }
}

/**
 * ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø§Ù„Ù€ Contour (Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø´ÙƒÙ„)
 */
function generateRouterContourGcode() {
  if (!grayMat || !contour) throw new Error("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­ÙˆØ§Ù");

  try {
    InputValidator.validateRouterSettings();

    const feed = parseInt(document.getElementById('feedRate').value) || 800;
    const safeZ = parseFloat(document.getElementById('safeZ').value) || 5;
    const maxDepth = parseFloat(document.getElementById('maxDepth').value) || 3;
    const invertZ = document.getElementById('invertZ').checked;

    const workWidth = cmToMm(parseFloat(document.getElementById('workWidth').value) || 30);
    const workHeight = cmToMm(parseFloat(document.getElementById('workHeight').value) || 20);
    const originX = 0, originY = 0;

    const lines = [];
    const precision = 3;
    const scaleX = workWidth / previewCanvas.width;
    const scaleY = workHeight / previewCanvas.height;

    // ================= Header =================
    lines.push('; ============================================================');
    lines.push('; ðŸ§  Generated by CncAi â€” Router Contour Milling');
    lines.push('; Version: 2.5.1 | Pattern: Contour');
    lines.push('; Date: ' + new Date().toLocaleString());
    lines.push(`; Feed: ${feed} mm/min | SafeZ: ${safeZ} mm | MaxDepth: ${maxDepth}`);
    lines.push('; ============================================================');
    lines.push('G90 G21 G17');
    lines.push('G28');
    lines.push('M3 ; Spindle ON');
    lines.push('; --- Begin Contour Pass ---');

    let totalLen = 0;

    const contoursToUse = [contour, ...additionalContours.map(c => c.contour)].filter(c => c);
    for (const cnt of contoursToUse) {
      const data = cnt.data32S;
      if (!data || data.length < 4) continue;

      let x0 = data[0], y0 = data[1];
      const startX = (x0 * scaleX + originX).toFixed(precision);
      const startY = (y0 * scaleY + originY).toFixed(precision);

      lines.push(`G0 X${startX} Y${startY}`);
      lines.push(`G0 Z${fmt(safeZ)}`);
      const zCut = invertZ ? safeZ + maxDepth : -maxDepth;
      lines.push(`G1 Z${fmt(zCut)} F${feed}`);

      for (let i = 2; i < data.length; i += 2) {
        const x = data[i], y = data[i + 1];
        const px = (x * scaleX + originX).toFixed(precision);
        const py = (y * scaleY + originY).toFixed(precision);
        lines.push(`G1 X${px} Y${py}`);
        totalLen += Math.hypot(x - x0, y - y0);
        x0 = x; y0 = y;
      }

      lines.push(`G1 X${startX} Y${startY}`);
      lines.push(`G0 Z${fmt(safeZ)}`);
    }

    // ================= Footer =================
    lines.push('; --- End Contour Pass ---');
    lines.push('M5 ; Spindle OFF');
    lines.push('G0 X0 Y0');
    lines.push('M84');
    lines.push('M30');
    lines.push('; âœ… Completed Successfully by CncAi');
    lines.push('; ============================================================');

    const timeMin = totalLen / (feed || 1);
    const estNode = document.getElementById('estTime');
    if (estNode) estNode.innerHTML =
      `â±ï¸ ØªÙ‚Ø¯ÙŠØ± ÙˆÙ‚Øª Ø§Ù„Ù‚Øµ: ${timeMin.toFixed(1)} Ø¯Ù‚ÙŠÙ‚Ø© | Ø·ÙˆÙ„ Ø§Ù„Ù…Ø³Ø§Ø± ${Math.round(totalLen)} Ù…Ù…`;

    return lines.join('\n');
  } catch (e) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Contour:', e);
    throw e;
  }
}
