// ===============================================================
// ğŸ§  CncAi â€” Router G-code Generator (Raster + Contour)
// Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø­Ø³Ù‘Ù† â€” 2025
// ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£ØµÙ„ÙŠ Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª:
// Header / Footer / Precision / Smart SafeZ / Home / Motor Off
// ===============================================================

// ğŸ§© Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
function fmt(v, p = 3) {
  return Number(v).toFixed(p);
}

// ===============================================================
// ğŸªµ ØªÙˆÙ„ÙŠØ¯ G-code Ù…Ù† Ù†ÙˆØ¹ Raster
// ===============================================================
function generateRasterGcode(scaleDown = false) {
  if (!grayMat || !contour) throw new Error("Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©");

  try {
    InputValidator.validateRouterSettings();

    const dir = document.getElementById('scanDir').value;
    lastScanDir = dir;
    const stepOver = parseFloat(document.getElementById('stepOver').value) || 5;
    const maxDepth = parseFloat(document.getElementById('maxDepth').value) || 3;
    const feed = parseFloat(document.getElementById('feedRate').value) || 800;
    const safeZ = parseFloat(document.getElementById('safeZ').value) || 5;
    const useFixedZ = document.getElementById('fixedZ').checked;
    const fixedZValue = parseFloat(document.getElementById('fixedZValue').value) || -1.0;
    const invertZ = document.getElementById('invertZ').checked;

    const workWidth = cmToMm(parseFloat(document.getElementById('workWidth').value) || 30);
    const workHeight = cmToMm(parseFloat(document.getElementById('workHeight').value) || 20);
    const originX = cmToMm(parseFloat(document.getElementById('originX').value) || 0);
    const originY = cmToMm(parseFloat(document.getElementById('originY').value) || 0);

    const lines = [];
    const precision = 3;
    let totalLen = 0;
    let lastZ = null;

    // âœ… Smart SafeZ function
    function moveSafeZ(targetZ) {
      if (lastZ !== targetZ) {
        lines.push(`G0 Z${fmt(targetZ, precision)}`);
        lastZ = targetZ;
      }
    }

    // ğŸ§± Header
    lines.push('; ============================================================');
    lines.push('; ğŸ§  Generated by CncAi â€” Router Raster Mode');
    lines.push('; Version: 2.5.1');
    lines.push('; Date: ' + new Date().toLocaleString());
    lines.push(`; SafeZ: ${safeZ} mm | Feed: ${feed} mm/min`);
    lines.push('; ============================================================');
    lines.push('G90 G21 G17');
    lines.push('G28 ; home all axes');
    moveSafeZ(safeZ);
    lines.push('M3 ; spindle on');
    lines.push('; --- Begin Raster cutting ---');

    const step = scaleDown ? stepOver * 4 : stepOver;
    const scaleX = workWidth / previewCanvas.width;
    const scaleY = workHeight / previewCanvas.height;

    if (dir === 'x') {
      for (let y = 0; y < previewCanvas.height; y += step) {
        const rowPoints = [];
        let inContour = false, segmentStart = -1;

        for (let x = 0; x < previewCanvas.width; x += 2) {
          const pt = new cv.Point(x, y);
          const inside = cv.pointPolygonTest(contour, pt, false) >= 0;
          if (inside && !inContour) { segmentStart = x; inContour = true; }
          else if (!inside && inContour) {
            addSegmentPoints(rowPoints, segmentStart, x - 1, y, scaleX, scaleY, originX, originY, maxDepth, invertZ, useFixedZ, fixedZValue);
            inContour = false;
          }
        }
        if (inContour)
          addSegmentPoints(rowPoints, segmentStart, previewCanvas.width - 1, y, scaleX, scaleY, originX, originY, maxDepth, invertZ, useFixedZ, fixedZValue);

        if (rowPoints.length > 1) {
          processRowPoints(rowPoints, lines, feed, safeZ, (y / step) % 2 !== 0);
          totalLen += calculateRowLength(rowPoints);
        }
      }
    } else {
      // direction Y
      for (let x = 0; x < previewCanvas.width; x += step) {
        const colPoints = [];
        let inContour = false, segmentStart = -1;

        for (let y = 0; y < previewCanvas.height; y += 2) {
          const pt = new cv.Point(x, y);
          const inside = cv.pointPolygonTest(contour, pt, false) >= 0;
          if (inside && !inContour) { segmentStart = y; inContour = true; }
          else if (!inside && inContour) {
            addVerticalSegmentPoints(colPoints, x, segmentStart, y - 1, scaleX, scaleY, originX, originY, maxDepth, invertZ, useFixedZ, fixedZValue);
            inContour = false;
          }
        }
        if (inContour)
          addVerticalSegmentPoints(colPoints, x, segmentStart, previewCanvas.height - 1, scaleX, scaleY, originX, originY, maxDepth, invertZ, useFixedZ, fixedZValue);

        if (colPoints.length > 1) {
          processRowPoints(colPoints, lines, feed, safeZ, (x / step) % 2 !== 0);
          totalLen += calculateRowLength(colPoints);
        }
      }
    }

    // ğŸ§© Footer
    lines.push('; --- End Raster cutting ---');
    moveSafeZ(safeZ);
    lines.push('M5 ; stop spindle');
    lines.push('G0 X0 Y0 ; return to home');
    lines.push('M84 ; disable motors');
    lines.push('M30 ; program end');
    lines.push('; âœ… Completed successfully by CncAi');
    lines.push('; ============================================================');

    const timeMin = (totalLen / (feed || 1)) + ((Math.max(0, safeZ) / 50) * (totalLen / 1000));
    document.getElementById('estTime').innerHTML = `â±ï¸ ØªÙ‚Ø¯ÙŠØ± Ø§Ù„ÙˆÙ‚Øª: ${timeMin.toFixed(1)} Ø¯Ù‚ÙŠÙ‚Ø©`;

    return lines.join('\n');
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ G-code (Raster):', error);
    throw new Error('ÙØ´Ù„ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ G-code (Raster): ' + error.message);
  }
}

// ===============================================================
// âœ‚ï¸ ØªÙˆÙ„ÙŠØ¯ G-code Ù…Ù† Ù†ÙˆØ¹ Contour
// ===============================================================
function generateContourGcode() {
  if (!grayMat || !contour) throw new Error("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­ÙˆØ§Ù Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯");

  try {
    InputValidator.validateRouterSettings();

    const mode = document.getElementById('contourMode').value || 'outer';
    lastScanDir = 'contour';
    const feed = parseFloat(document.getElementById('feedRate').value) || 800;
    const safeZ = parseFloat(document.getElementById('safeZ').value) || 5;
    const maxDepth = parseFloat(document.getElementById('maxDepth').value) || 3;
    const useFixedZ = document.getElementById('fixedZ').checked;
    const fixedZValue = parseFloat(document.getElementById('fixedZValue').value) || -1.0;
    const invertZ = document.getElementById('invertZ').checked;

    const workWidth = cmToMm(parseFloat(document.getElementById('workWidth').value) || 30);
    const workHeight = cmToMm(parseFloat(document.getElementById('workHeight').value) || 20);
    const originX = cmToMm(parseFloat(document.getElementById('originX').value) || 0);
    const originY = cmToMm(parseFloat(document.getElementById('originY').value) || 0);
    const scaleX = workWidth / previewCanvas.width;
    const scaleY = workHeight / previewCanvas.height;

    const lines = [];
    const precision = 3;
    let totalLen = 0;

    // ğŸ§± Header
    lines.push('; ============================================================');
    lines.push('; ğŸ§  Generated by CncAi â€” Router Contour Mode');
    lines.push('; Version: 2.5.1');
    lines.push('; Date: ' + new Date().toLocaleString());
    lines.push(`; SafeZ: ${safeZ} mm | Feed: ${feed} mm/min | MaxDepth: ${maxDepth}`);
    lines.push('; ============================================================');
    lines.push('G90 G21 G17');
    lines.push('G28');
    lines.push('M3 ; spindle on');
    lines.push('G0 Z' + fmt(safeZ));
    lines.push('; --- Begin contour cutting ---');

    const contoursToUse = (mode === 'outer') ? [contour] : [contour, ...additionalContours.map(c => c.contour)];

    for (const cnt of contoursToUse) {
      if (!cnt) continue;
      const data = cnt.data32S;
      if (!data || data.length < 4) continue;

      let x0 = data[0], y0 = data[1];
      const startX = (x0 * scaleX + originX).toFixed(precision);
      const startY = (y0 * scaleY + originY).toFixed(precision);

      const pv0 = sampleGrayAt(x0, y0);
      let zStart = useFixedZ ? fixedZValue : -((255 - pv0) / 255.0) * maxDepth;
      if (invertZ) zStart = -zStart;

      lines.push(`G0 X${startX} Y${startY} Z${fmt(safeZ)}`);
      lines.push(`G1 F${feed}`);
      lines.push(`G1 Z${fmt(zStart)}`);

      for (let i = 2; i < data.length; i += 2) {
        const x = data[i], y = data[i + 1];
        const px = (x * scaleX + originX).toFixed(precision);
        const py = (y * scaleY + originY).toFixed(precision);
        const pv = sampleGrayAt(x, y);
        let zVal = useFixedZ ? fixedZValue : -((255 - pv) / 255.0) * maxDepth;
        if (invertZ) zVal = -zVal;
        lines.push(`G1 X${px} Y${py} Z${fmt(zVal)}`);
        totalLen += Math.hypot(x - x0, y - y0);
        x0 = x; y0 = y;
      }

      lines.push(`G1 X${startX} Y${startY} Z${fmt(zStart)}`);
      lines.push(`G0 Z${fmt(safeZ)}`);
    }

    // ğŸ§© Footer
    lines.push('; --- End of contour cutting ---');
    lines.push('M5 ; stop spindle');
    lines.push('G0 X0 Y0 ; return to home');
    lines.push('M84 ; disable motors');
    lines.push('M30 ; program end');
    lines.push('; âœ… Completed successfully by CncAi');
    lines.push('; ============================================================');

    const timeMin = totalLen / (feed || 800);
    document.getElementById('estTime').innerHTML = `â±ï¸ ØªÙ‚Ø¯ÙŠØ± ÙˆÙ‚Øª Ø§Ù„Ù‚Øµ (Contour): ${timeMin.toFixed(1)} Ø¯Ù‚ÙŠÙ‚Ø©`;

    return lines.join('\n');
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ G-code (Contour):', error);
    throw new Error('ÙØ´Ù„ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ G-code (Contour): ' + error.message);
  }
}
